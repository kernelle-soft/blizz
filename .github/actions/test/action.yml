name: 'Test with Optional Coverage'
description: 'Runs Blizz tests and optionally generates coverage reports with PR comments and badge updates'

inputs:
  report-coverage:
    description: 'Whether to generate coverage reports'
    required: false
    default: 'false'
  post-pr-comment:
    description: 'Whether to post coverage as PR comment (only effective when report-coverage is true)'
    required: false
    default: 'false'
  update-badge:
    description: 'Whether to update coverage badge in README (only effective when report-coverage is true and on push to dev)'
    required: false
    default: 'false'
  coverage-artifact-name:
    description: 'Name for the coverage artifact'
    required: false
    default: 'coverage'

runs:
  using: 'composite'
  steps:
    # Simple Case: Run tests without coverage
    - name: Run tests
      if: inputs.report-coverage != 'true'
      shell: bash
      run: blizz do test

    - name: Free up disk space and add swap for coverage builds
      if: inputs.report-coverage == 'true'
      shell: bash
      run: |
        echo "ðŸ§¹ Freeing up disk space for coverage build artifacts..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android  
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        
        echo "ðŸ”„ Adding swap space as additional safety margin..."
        sudo fallocate -l 8G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "ðŸ“Š Available resources on runner after setup:"
        free -h
        df -h
    
    - name: Run tests with coverage
      if: inputs.report-coverage == 'true'
      shell: bash
      env:
        # Reduce parallel compilation to avoid memory pressure and timeouts
        CARGO_BUILD_JOBS: 2
        RUSTFLAGS: '-C codegen-units=1'
      run: |
        echo "ðŸ”§ Running coverage build with swap space for memory spikes..."
        
        # Start background resource monitoring
        (while true; do
          echo "$(date): Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
          echo "$(date): Swap: $(free -h | grep Swap | awk '{print $3 "/" $2}')"
          echo "$(date): Load: $(uptime | awk -F'load average:' '{print $2}')"
          echo "$(date): Disk: $(df -h / | tail -1 | awk '{print $4 " available"}')"
          sleep 30
        done) &
        MONITOR_PID=$!
        
        # Try coverage build with swap available
        blizz do coverage
        
        # Stop monitoring
        kill $MONITOR_PID 2>/dev/null || true
        
        echo "âœ… Coverage build completed successfully"

    - name: Upload Coverage Reports
      if: inputs.report-coverage == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.coverage-artifact-name }}
        path: coverage/
        retention-days: 30
      
    - name: Generate coverage summary
      if: inputs.report-coverage == 'true'
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        filename: coverage/cobertura.xml
        format: markdown
        output: both
        indicators: true
        badge: true

    - name: Post coverage as PR comment
      if: inputs.report-coverage == 'true' && inputs.post-pr-comment == 'true' && github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        path: code-coverage-results.md
        
    - name: Update coverage badge in README
      if: inputs.report-coverage == 'true' && inputs.update-badge == 'true' && github.ref == 'refs/heads/dev' && github.event_name == 'push'
      shell: bash
      run: |
        # Extract the badge line (first line) from the coverage results
        NEW_BADGE=$(head -n 1 code-coverage-results.md)
        
        # Replace the coverage badge line in README.md
        sed -i "s|^!\[Code Coverage\](https://img\.shields\.io/badge/.*|$NEW_BADGE|" README.md
        
        # Check if there were changes
        if git diff --quiet README.md; then
          echo "No changes to README.md"
        else
          echo "Coverage badge updated in README.md"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update coverage badge [skip ci]"
          git push
        fi
